import {defineStore} from "pinia";
import i18n from "@/i18n/index.js"

const {t} = i18n.global
export const useExamAttemptStore = defineStore('examAttemptStore', {
    state: () => ({
        questions: [{
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        }, {
            "id": 3,
            "question": "<p>Yangi savollar</p>",
            "answers": [
                {
                    "id": 1,
                    "text": "<p>1</p>"
                },
                {
                    "id": 2,
                    "text": "<p>2</p>"
                },
                {
                    "id": 3,
                    "text": "<p>3</p>"
                }
            ],
            "result": null
        },],
        exam_token: null,
        worker_detail: {
            "id": 9,
            "created": "2025-02-21T12:54:48.944049Z",
            "ended": null,
            "result": null,
            "ip_address": "192.168.136.76",
            "user_agent": "PostmanRuntime/7.43.0",
            "user": {
                "photo": "http://192.168.136.78:8004/assets/img/users/1.jpg",
                "last_name": "Boboqulov",
                "first_name": "Jobir",
                "middle_name": "Xasanovich",
                "phone": 977226656
            }
        },
        exam_detail:  {
            "id": 12,
            "name": "Nimabu",
            "deadline": "2025-02-28 17:48:06",
            "variant": 3,
            "minute": 3,
            "chances": 3,
            "active": 0,
            "description": null
        },
        loading: false,
        continueVisible: false,
        notPermittedVisible: false,
        visibleType: true,
        elementId: null,
        allPermissionList: [],
        isNewAttempt: true,
        payload: {
            name: null,
        },
        finishLoading: false
    }),
    actions: {
        _config_localstorage() {
            let data = localStorage.getItem('exam_data')
            data = data && JSON.parse(data)
            this.exam_token = data && data[this.elementId]
        },
        _start_attempt() {
            this.loading = true
            $ApiService.workerExamService._start_exam({id: this.elementId}).then((res) => {
                const {active_token, questions, worker_exam_details, exam} = res.data.data
                this.exam_detail = exam
                this.questions = questions
                this.worker_detail = worker_exam_details
                this.exam_token = active_token
                let data = localStorage.getItem('exam_data')
                data = data ? JSON.parse(data) : {}
                localStorage.setItem('exam_data', JSON.stringify({...data, [this.elementId]: active_token}))
            }).catch((res) => {
                if (this.exam_token) {
                    this.continueVisible = true
                } else {
                    this.notPermittedVisible = true
                }
            }).finally(() => {
                this.loading = false
            })
        },
        _continue_attempt() {
            this.loading = true
            $ApiService.workerExamService._continue_exam({id: this.elementId, token: this.exam_token}).then((res) => {
                const {active_token, questions, worker_exam_details} = res.data.data
                this.questions = questions
                this.exam_detail = worker_exam_details
                // this.exam_token =  active_token
                // let data = localStorage.getItem('exam_data')
                // data = data ? JSON.parse(data) : {}
                // localStorage.setItem('exam_data', JSON.stringify({...data, [this.elementId]: active_token}))
            }).catch((res) => {
                if (this.exam_token) {
                    this.notPermittedVisible = true
                }
            }).finally(() => {
                this.loading = false
            })
        },
        _attempt() {
            if (this.isNewAttempt) {
                this._start_attempt()
            } else {
                this._continue_attempt()
            }
        },
        _finish_attempt() {
            this.finishLoading = true
            $ApiService.workerExamService._finish_exam({id: this.elementId, token: this.exam_token}).then((res) => {
                let data = localStorage.getItem('exam_data')
                data = data ? JSON.parse(data) : {}
                delete data?.[this.elementId]
                localStorage.setItem('exam_data', JSON.stringify({...data}))

            }).catch((res) => {

            }).finally(() => {
                this.finishLoading = false
            })
        },
        openVisible(data) {
            this.visible = data
        },
        resetForm() {
            this.payload.name = null
        }
    }
})